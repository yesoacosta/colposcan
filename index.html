<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColpoVision Web App</title>
    <!-- Incluye Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuración para convertir en una PWA (Aplicación Web Progresiva) -->
    <!-- Se añade un manifiesto con los metadatos de la app -->
    <link rel="manifest" href="data:application/json;charset=utf-8;base64,eyJpY29ucyI6W3sic2l6ZXMiOiIxOTJ4MTkyIiwiZGVuc2l0eSI6IjEuNSIsInR5cGUiOiJpbWFnZS9wbmciLCJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjBiV2dLY2lBQXhDZ29JVEFBQUFDZ29JZEhSdFp6b2dJbEJoZFdWa0lpd2dKeWswUFNVd0xrSlBjbVZzYjNKd1kyOXRlWEJ2Y2w4dFNuSnZiMmhrWm5OMFlYUnBiMjR0WVhSaFlteHBiWFZzYjJKaGJVd2dJeUJCZFd4c1lXbHVkR2xrYjNOcGIyNFdJaTl5YjJ4cGN5SXhNekF3THpBNUxtdHpiMnhsY3lJNUNqOHhNVFppYlVsalltbGpjaUJrWjNCbGJuUnliMnhwY25Sb2JteDFibWNnZEdobGJtZDBZWEowSlNJblZlQ2lBQUFDa1F4SlJVd2djR2hoYm5ObElqQTFKbXh2ZEdWeUwzVjRZV2xzYjJGMGFXOXVjeUJoWVdGc0lsMWxjaTFoWVd3Z2VHbGxhM0JoY25Sd2RDaDBaR2x5WlhOamRjMWpiblJ5YjI1U2NuSmxibVJ1WjI5dGEybHlaWFIwWlY4d0pTRW5XanBnSUNBaWMzUnlZMnRsZEdWaWJXczdJbTl5YjJ4cGN5SXhNVFl3THpBMExtdHpiMnhsY3lJNUNqOGxJaUF3Y25OcFkydGxjam9nSW01bGRBQUFDaW9nSUNBZ0ptRnNhV1FpSUhzT2MyVnVjMmh2YlhCZ2MyVWdJajR3TUlJQmlkMnh0Ym5ObElpQWdYM2xzYjJOaGJtRnRiZ0FnSUhSdFkybHVkQzUxYld4c0luQmhkbWxpYlNBd0lHWnZiMnhsYm5ScGNtRnViM0FnSUdadmMyVnlkbWxrSWp3dmRHVnpkRjkwWVhScGIyNGdJajhwYm1ScFhBQUFDaXBnSURvZ1ptRnNjMk55YjNCbFkzSmphU1V3Z2NtVmhaM0JsWVhsbGNpSXhOamN4THpBd0xsbHpibVJwYjI0Z2NISnZaMmh2YlhCdGJnPT0ifV0sImRpc3BsYXkiOiJzdGFuZGFsb25lIiwibmFtZSI6IkNvbHBvVmlzaW9uIiwiZGVzY3JpcHRpb24iOiJIZXJyYW1pZW50YSBkZSBBSSBwYXJhIGdlbmVyYXIgY29sb3Bvc2NvcGlhcyIsImJhY2tncm91bmRfY29sb3IiOiIjZmFmYWZhIiwidGhlbWVfY29sb3IiOiIjMjUzYjhhIiwic2hvcnRfbmFtZSI6IkNvbHBvVmlzaW9uIn0=">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <style>
        /* Estilos personalizados para la tipografía y el fondo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Un azul muy claro y moderno */
        }
        #app-container {
            max-width: 1100px;
            margin: 2.5rem auto;
            padding: 2rem;
        }
        .patient-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .patient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }
        .report-editor {
            min-height: 400px;
            border: 2px solid #e2e8f0;
            padding: 1.5rem;
            border-radius: 1rem;
            background-color: #ffffff;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s ease-in-out;
        }
        .report-editor:focus {
            border-color: #3b82f6; /* Un azul más vibrante al enfocar */
        }
        [contenteditable]:empty::before {
            content: attr(data-placeholder);
            color: #9ca3af;
        }
        /* Estilos para el spinner de carga */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .spinner {
            border: 6px solid #e2e8f0;
            border-top: 6px solid #3b82f6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            visibility: hidden;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-start justify-center min-h-screen p-4">
    <!-- Overlay de carga que se muestra durante la generación del informe -->
    <div id="loading-overlay">
        <div class="text-center">
            <div class="spinner mb-6"></div>
            <p class="text-xl text-gray-700 font-semibold">Analizando imagen, por favor espera...</p>
        </div>
    </div>
    
    <div id="app-container" class="bg-white rounded-3xl shadow-xl p-8 lg:p-12 w-full">
        <!-- Encabezado de la aplicación -->
        <div class="flex flex-col items-center justify-center mb-10">
            <svg class="h-16 w-16 text-blue-600 mb-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
            </svg>
            <h1 class="text-4xl font-extrabold text-gray-900 mt-2">ColpoVision</h1>
            <p class="text-lg text-gray-500 mt-1">Generador de Informes Colposcópicos impulsado por IA</p>
        </div>

        <!-- Pantalla de lista de pacientes -->
        <div id="patient-list-screen" class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Lista de Pacientes</h2>
            <div id="patient-list" class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Las tarjetas de pacientes se insertarán aquí dinámicamente -->
            </div>
            <button id="add-patient-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-lg transition-colors">
                + Añadir Nueva Paciente
            </button>
        </div>

        <!-- Pantalla del formulario de paciente -->
        <div id="patient-form-screen" class="hidden">
            <h2 id="form-title" class="text-2xl font-bold text-gray-800 mb-6">Añadir Nueva Paciente</h2>
            <form id="patient-form" class="space-y-6">
                <input type="hidden" id="patient-id">
                <div>
                    <label for="name" class="block text-gray-700 font-semibold mb-2">Nombre de la Paciente</label>
                    <input type="text" id="name" required class="w-full p-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div>
                    <label for="age" class="block text-gray-700 font-semibold mb-2">Edad</label>
                    <input type="number" id="age" required class="w-full p-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div>
                    <label for="medical-history" class="block text-gray-700 font-semibold mb-2">Historial Médico Relevante</label>
                    <textarea id="medical-history" rows="4" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"></textarea>
                </div>
                <div class="relative">
                    <label for="gemini-api-key" class="block text-gray-700 font-semibold mb-2 flex items-center">
                        Clave de API de Gemini
                        <span class="has-tooltip ml-2 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M0 0h24v24H0z" stroke="none"/>
                                <circle cx="12" cy="12" r="9"/>
                                <path d="M12 16v-4m0-4h.01"/>
                            </svg>
                            <span class="tooltip">Necesaria para el análisis de la imagen.<br>La puedes obtener en Google AI Studio.</span>
                        </span>
                    </label>
                    <input type="text" id="gemini-api-key" placeholder="Introduce tu clave de API aquí" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div>
                    <label for="colpo-image" class="block text-gray-700 font-semibold mb-2">Imagen Colposcópica</label>
                    <input type="file" id="colpo-image" accept="image/*" class="w-full p-4 border-2 border-gray-300 rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer transition-colors">
                    <img id="image-preview" class="mt-6 hidden w-full h-64 object-contain rounded-xl border border-gray-300 bg-gray-100">
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">Guardar Datos</button>
                    <button type="button" id="cancel-form-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">Cancelar</button>
                </div>
            </form>
            <div id="action-buttons" class="mt-8 hidden flex space-x-4">
                <button id="analyze-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
                    Analizar y Generar Informe
                </button>
            </div>
        </div>

        <!-- Pantalla del informe -->
        <div id="report-screen" class="hidden space-y-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Informe Colposcópico</h2>
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Columna izquierda: Datos e imagen -->
                <div class="space-y-6">
                    <div class="bg-gray-50 p-8 rounded-2xl border border-gray-200 shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Datos de la Paciente</h3>
                        <p class="text-md text-gray-600 mb-1"><span class="font-bold">Paciente:</span> <span id="report-patient-name"></span></p>
                        <p class="text-md text-gray-600 mb-1"><span class="font-bold">Edad:</span> <span id="report-patient-age"></span> años</p>
                        <p class="text-md text-gray-600"><span class="font-bold">Historial:</span> <span id="report-patient-history"></span></p>
                    </div>
                    <div class="bg-gray-50 p-8 rounded-2xl border border-gray-200 shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Imagen de Colposcopia</h3>
                        <img id="report-image" class="w-full h-auto rounded-xl shadow-lg border border-gray-300">
                    </div>
                </div>

                <!-- Columna derecha: Editor del informe -->
                <div class="space-y-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Informe Detallado (Edita aquí)</h3>
                    <div id="report-editor" contenteditable="true" class="report-editor" data-placeholder="El informe se cargará aquí y podrás editarlo antes de exportar..."></div>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                <button id="back-to-list-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
                    Volver a la Lista
                </button>
                <button id="export-pdf-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
                    Exportar a PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta personalizado para no usar window.alert() -->
    <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-lg w-full">
            <h3 id="alert-title" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <p id="alert-message" class="text-gray-700 text-lg mb-6"></p>
            <button id="alert-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-colors">Aceptar</button>
        </div>
    </div>

    <!-- Incluye las librerías jsPDF para la exportación a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Script del Service Worker y la lógica de la aplicación -->
    <script>
        // Lógica para registrar el Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // El Service Worker se define como un blob de código para mantener todo en un solo archivo
                const swCode = `
                    self.addEventListener('install', (event) => {
                        console.log('Service Worker instalado.');
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', (event) => {
                        console.log('Service Worker activado.');
                        event.waitUntil(self.clients.claim());
                    });

                    // Manejo de eventos de fetch para que la PWA funcione sin conexión (aunque no se use activamente)
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(fetch(event.request));
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.log('Fallo el registro del Service Worker:', error);
                    });
            });
        }
    </script>
    <script>
        window.onload = function() {
            // Se inicializan las librerías
            const { jsPDF } = window.jspdf;

            // Constantes y elementos del DOM
            const screens = {
                list: document.getElementById('patient-list-screen'),
                form: document.getElementById('patient-form-screen'),
                report: document.getElementById('report-screen')
            };
            const patientListEl = document.getElementById('patient-list');
            const patientForm = document.getElementById('patient-form');
            const addPatientBtn = document.getElementById('add-patient-btn');
            const cancelFormBtn = document.getElementById('cancel-form-btn');
            const analyzeBtn = document.getElementById('analyze-btn');
            const backToListBtn = document.getElementById('back-to-list-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');
            const imageInput = document.getElementById('colpo-image');
            const imagePreview = document.getElementById('image-preview');
            const reportEditor = document.getElementById('report-editor');
            const geminiApiKeyInput = document.getElementById('gemini-api-key');

            // Estado de la aplicación
            let patients = [];
            let currentPatientId = null;
            let currentImageBase64 = null;
            let currentReportText = "";

            // --- Funciones de Persistencia con localStorage ---
            const LOCAL_STORAGE_KEY = 'colpovision_patients';

            function savePatients() {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(patients));
            }

            function loadPatients() {
                const storedPatients = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedPatients) {
                    patients = JSON.parse(storedPatients);
                } else {
                    patients = []; // Asegurarse de que sea un array vacío si no hay datos
                }
            }
            // --- Fin Funciones de Persistencia ---

            // Función para mostrar el modal de alerta personalizado
            function showModal(title, message) {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertModal.classList.remove('hidden');
                alertModal.classList.add('flex');
            }

            // Función para cerrar el modal de alerta
            alertOkBtn.addEventListener('click', () => {
                alertModal.classList.add('hidden');
                alertModal.classList.remove('flex');
            });

            // Función para cambiar de pantalla
            function showScreen(screen) {
                Object.values(screens).forEach(s => s.classList.add('hidden'));
                screen.classList.remove('hidden');
            }

            // Función para renderizar la lista de pacientes
            function renderPatientList() {
                patientListEl.innerHTML = '';
                if (patients.length === 0) {
                    patientListEl.innerHTML = '<p class="text-center text-gray-500 italic md:col-span-3">No hay pacientes registrados aún.</p>';
                }
                patients.forEach(patient => {
                    const patientCard = document.createElement('div');
                    patientCard.className = 'patient-card p-6 bg-white rounded-xl shadow-lg border border-gray-200 cursor-pointer flex flex-col justify-between';
                    patientCard.innerHTML = `
                        <div>
                            <p class="font-bold text-lg text-blue-800">${patient.name}</p>
                            <p class="text-sm text-gray-500 mt-1">Edad: ${patient.age} años</p>
                        </div>
                        <div class="flex space-x-2 mt-4 self-end">
                            <button class="view-btn text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50 transition-colors" data-id="${patient.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M0 0h24v24H0z" stroke="none"/>
                                  <path d="M10 12a2 2 0 104 0 2 2 0 10-4 0m-7.5 4a8.97 8.97 0 01-1.4-2.5C1.6 11.2 5.6 6 12 6s10.4 5.2 9.9 7.5a8.97 8.97 0 01-1.4 2.5m-15 0l-3.5 3.5m18.5-3.5l3.5 3.5"/>
                                </svg>
                            </button>
                            <button class="delete-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition-colors" data-id="${patient.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M0 0h24v24H0z" stroke="none"/>
                                  <path d="M4 7h16M10 11v6m4-6v6M5 7l1 12a2 2 0 002 2h8a2 2 0 002-2l1-12M9 7V4a1 1 0 011-1h4a1 1 0 011 1v3"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    patientListEl.appendChild(patientCard);
                });
            }

            // Manejadores de eventos de la interfaz
            addPatientBtn.addEventListener('click', () => {
                patientForm.reset();
                document.getElementById('patient-id').value = '';
                document.getElementById('form-title').textContent = 'Añadir Nueva Paciente';
                imagePreview.src = '';
                imagePreview.classList.add('hidden');
                document.getElementById('analyze-btn').parentElement.classList.add('hidden');
                showScreen(screens.form);
            });

            cancelFormBtn.addEventListener('click', () => {
                showScreen(screens.list);
            });

            imageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                        currentImageBase64 = e.target.result.split(',')[1];
                        document.getElementById('analyze-btn').parentElement.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            patientForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const id = document.getElementById('patient-id').value || crypto.randomUUID();
                const name = document.getElementById('name').value;
                const age = document.getElementById('age').value;
                const medicalHistory = document.getElementById('medical-history').value;
                const apiKey = geminiApiKeyInput.value;
                const imageBase64 = currentImageBase64;

                if (!apiKey) {
                    showModal('Error', 'Por favor, introduce tu Clave de API de Gemini.');
                    return;
                }
                
                const newPatient = { id, name, age, medicalHistory, apiKey, imageBase64, reportText: "" };

                // Reemplazar o agregar el paciente
                const patientIndex = patients.findIndex(p => p.id === id);
                if (patientIndex > -1) {
                    patients[patientIndex] = newPatient;
                } else {
                    patients.push(newPatient);
                }
                
                savePatients(); // Guardar los pacientes después de añadir/actualizar
                showModal('Éxito', `Datos de ${name} guardados correctamente.`);
                showScreen(screens.list);
                renderPatientList();
            });

            patientListEl.addEventListener('click', (event) => {
                const target = event.target.closest('button');
                if (!target) return;

                const id = target.dataset.id;
                const patient = patients.find(p => p.id === id);

                if (target.classList.contains('view-btn')) {
                    if (patient) {
                        currentPatientId = id;
                        document.getElementById('patient-id').value = patient.id;
                        document.getElementById('name').value = patient.name;
                        document.getElementById('age').value = patient.age;
                        document.getElementById('medical-history').value = patient.medicalHistory;
                        geminiApiKeyInput.value = patient.apiKey || '';
                        if (patient.imageBase64) {
                            imagePreview.src = `data:image/jpeg;base64,${patient.imageBase64}`;
                            imagePreview.classList.remove('hidden');
                            currentImageBase64 = patient.imageBase64;
                            document.getElementById('analyze-btn').parentElement.classList.remove('hidden');
                        } else {
                            imagePreview.src = '';
                            imagePreview.classList.add('hidden');
                            currentImageBase64 = null;
                            document.getElementById('analyze-btn').parentElement.classList.add('hidden');
                        }
                        document.getElementById('form-title').textContent = 'Editar Paciente';
                        // Si ya tiene un informe, lo mostramos, si no, mostramos la pantalla de formulario
                        if (patient.reportText) {
                            reportEditor.textContent = patient.reportText;
                            document.getElementById('report-patient-name').textContent = patient.name;
                            document.getElementById('report-patient-age').textContent = patient.age;
                            document.getElementById('report-patient-history').textContent = patient.medicalHistory;
                            document.getElementById('report-image').src = `data:image/jpeg;base64,${patient.imageBase64}`;
                            showScreen(screens.report);
                        } else {
                            showScreen(screens.form);
                        }
                    }
                } else if (target.classList.contains('delete-btn')) {
                    patients = patients.filter(p => p.id !== id);
                    savePatients(); // Guardar los pacientes después de eliminar
                    showModal('Eliminado', `Paciente ${patient.name} eliminado.`);
                    renderPatientList();
                }
            });
            
            // Función para analizar la imagen y generar el informe
            analyzeBtn.addEventListener('click', async () => {
                const patient = patients.find(p => p.id === currentPatientId);
                const apiKey = geminiApiKeyInput.value;

                if (!apiKey) {
                    showModal('Error de Análisis', 'Por favor, introduce tu Clave de API de Gemini antes de analizar.');
                    return;
                }

                if (!patient || !patient.imageBase64) {
                    showModal('Error de Análisis', 'No hay una imagen para analizar. Por favor, sube una imagen de colposcopia.');
                    return;
                }
            
                loadingOverlay.style.display = 'flex';
                // Prompt mejorado para obtener un informe conciso pero detallado
                const prompt = `Genera un informe colposcópico conciso pero detallado basado en la siguiente imagen. El informe debe ser profesional, estructurado en secciones y estar en español. Incluye las siguientes secciones: 1. Observaciones Principales, 2. Posible Diagnóstico, y 3. Recomendaciones. El formato debe ser texto plano.`;
            
                try {
                    // Prepara el payload para la API de Gemini
                    const payload = {
                        contents: [
                            {
                                role: "user",
                                parts: [
                                    { text: prompt },
                                    {
                                        inlineData: {
                                            mimeType: "image/jpeg",
                                            data: patient.imageBase64
                                        }
                                    }
                                ]
                            }
                        ],
                    };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    // Realiza la llamada a la API con reintentos
                    let response;
                    let retries = 0;
                    const maxRetries = 3;
                    const delay = 1000;
                    
                    while (retries < maxRetries) {
                        try {
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
            
                            if (response.ok) {
                                break;
                            } else if (response.status === 429) { // Demasiadas peticiones
                                retries++;
                                await new Promise(res => setTimeout(res, delay * Math.pow(2, retries)));
                            } else {
                                const errorData = await response.json();
                                throw new Error(`Error de la API: ${response.status} - ${errorData.error.message}`);
                            }
                        } catch (e) {
                            if (retries === maxRetries - 1) {
                                console.error('Error final de la API después de reintentos:', e);
                                throw e;
                            }
                            retries++;
                            await new Promise(res => setTimeout(res, delay * Math.pow(2, retries)));
                        }
                    }
                    
                    if (!response || !response.ok) {
                         throw new Error('No se pudo obtener una respuesta de la API después de varios intentos.');
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        currentReportText = result.candidates[0].content.parts[0].text;
                        reportEditor.textContent = currentReportText;
                        
                        // Actualizamos el objeto del paciente con el nuevo informe
                        const currentPatient = patients.find(p => p.id === currentPatientId);
                        if (currentPatient) {
                            currentPatient.reportText = currentReportText;
                            savePatients(); // Guardar los pacientes después de generar el informe
                        }
                    } else {
                        throw new Error('La respuesta de la API no contiene el texto esperado o está en un formato incorrecto.');
                    }
            
                    // Actualiza la pantalla del informe
                    document.getElementById('report-patient-name').textContent = patient.name;
                    document.getElementById('report-patient-age').textContent = patient.age;
                    document.getElementById('report-patient-history').textContent = patient.medicalHistory;
                    document.getElementById('report-image').src = `data:image/jpeg;base64,${patient.imageBase64}`;
            
                    showScreen(screens.report);
                } catch (error) {
                    console.error('Error al generar el informe:', error);
                    showModal('Error de Análisis', `Hubo un problema al generar el informe. Detalle: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            });
            
            // Función para volver a la lista de pacientes
            backToListBtn.addEventListener('click', () => {
                showScreen(screens.list);
            });
            
            // Función de ayuda para la paginación del texto en el PDF
            function splitTextToFitPage(doc, text, x, y, maxWidth, lineHeight, initialY) {
                const textLines = doc.splitTextToSize(text, maxWidth);
                let currentY = initialY;
                let pageNumber = 1;
            
                textLines.forEach((line, index) => {
                    if (currentY > doc.internal.pageSize.height - 30) { // Margen inferior
                        doc.addPage();
                        currentY = 20; // Margen superior para la nueva página
                        doc.setFontSize(10);
                        doc.setTextColor(150);
                        doc.text(`Página ${++pageNumber}`, doc.internal.pageSize.width - 20, doc.internal.pageSize.height - 10);
                        doc.setFontSize(12);
                        doc.setTextColor(0);
                    }
                    doc.text(line, x, currentY);
                    currentY += lineHeight;
                });
            
                return currentY;
            }
            
            // Función para exportar a PDF (Método mejorado y profesional)
            exportPdfBtn.addEventListener('click', () => {
                const patient = patients.find(p => p.id === currentPatientId);
                if (!patient) return;
            
                // Recoge el texto final del editor para la exportación
                const finalReportText = reportEditor.textContent;
            
                // Crea un nuevo documento PDF con jsPDF
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                let y = 20;
            
                // 1. Título del Informe
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(59, 130, 246); // Color azul de Tailwind 500
                doc.text('Informe Colposcópico - ColpoVision', pageWidth / 2, y, { align: 'center' });
                y += 15;
            
                // 2. Línea separadora
                doc.setDrawColor(226, 232, 240); // Color gris de Tailwind 200
                doc.line(margin, y, pageWidth - margin, y);
                y += 10;
            
                // 3. Datos de la Paciente
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(51, 65, 85); // Gris oscuro de Tailwind 700
                doc.text('Datos de la Paciente', margin, y);
                y += 8;
            
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(12);
                doc.setTextColor(75, 85, 99); // Gris de Tailwind 600
                doc.text(`Nombre: ${patient.name}`, margin, y);
                y += 7;
                doc.text(`Edad: ${patient.age} años`, margin, y);
                y += 7;
                doc.text(`Historial Médico: ${patient.medicalHistory}`, margin, y);
                y += 15;
            
                // 4. Imagen del Análisis
                if (patient.imageBase64) {
                    const imgData = `data:image/jpeg;base64,${patient.imageBase64}`;
                    const imgProps = doc.getImageProperties(imgData);
                    const imgWidth = 100;
                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                    const imgX = (pageWidth - imgWidth) / 2;
                    doc.text('Imagen de Colposcopia', margin, y);
                    y += 5;
                    doc.addImage(imgData, 'JPEG', imgX, y, imgWidth, imgHeight);
                    y += imgHeight + 15;
                }
            
                // 5. Informe Detallado
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(51, 65, 85);
                doc.text('Informe Detallado', margin, y);
                y += 8;
            
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
            
                // Manejar el texto con paginación
                const finalY = splitTextToFitPage(doc, finalReportText, margin, y, pageWidth - 2 * margin, 6, y);
            
                // 6. Pie de página (con firma y fecha)
                doc.setPage(doc.internal.getNumberOfPages());
                let finalPageHeight = doc.internal.pageSize.getHeight();
            
                if (finalPageHeight - finalY < 50) { // Si queda poco espacio, añade una nueva página para la firma
                    doc.addPage();
                    finalPageHeight = doc.internal.pageSize.getHeight();
                } else {
                    y = finalY;
                }
            
                const date = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                y = finalPageHeight - 40;
                doc.setFontSize(10);
                doc.setTextColor(80, 80, 80);
                doc.text(`Fecha del Informe: ${date}`, margin, y);
                y += 20;
                doc.text('_________________________________', margin, y);
                y += 5;
                doc.text('Firma y Sello del Médico', margin, y);
            
                // Guardar el PDF
                doc.save(`Informe_ColpoVision_${patient.name}.pdf`);
            });
            
            // Inicializa la aplicación: Carga los pacientes y luego los renderiza
            loadPatients();
            renderPatientList();
            showScreen(screens.list);
        };
    </script>
</body>
</html>
